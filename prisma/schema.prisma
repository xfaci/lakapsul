// Prisma Schema for La Kapsul
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

enum UserRole {
  ARTIST
  PROVIDER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  role          UserRole  @default(ARTIST)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile              Profile?
  artistBookings       Booking[]         @relation("ArtistBookings")
  providerBookings     Booking[]         @relation("ProviderBookings")
  sentMessages         Message[]         @relation("SentMessages")
  conversations        ConversationUser[]
  forumThreads         ForumThread[]
  forumPosts           ForumPost[]
  notifications        Notification[]
  reviews              Review[]          @relation("ReviewAuthor")
  receivedReviews      Review[]          @relation("ReviewTarget")
  
  // Stripe relations
  subscription         Subscription?
  boosts               Boost[]
  payouts              Payout[]
  stripeAccount        StripeAccount?
}

// ==================== PROFILES ====================

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  username    String   @unique
  displayName String?
  bio         String?
  avatarUrl   String?
  coverUrl    String?
  location    String?
  skills      String[] @default([])
  
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  
  services    Service[]
  media       Media[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== SERVICES ====================

enum ServiceType {
  RECORDING
  MIXING
  MASTERING
  BEATMAKING
  VOCAL_COACHING
  OTHER
}

model Service {
  id          String      @id @default(cuid())
  profileId   String
  profile     Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  price       Float
  duration    Int         // in minutes
  type        ServiceType
  isActive    Boolean     @default(true)
  
  bookings    Booking[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// ==================== BOOKINGS ====================

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model Booking {
  id          String        @id @default(cuid())
  
  artistId    String
  artist      User          @relation("ArtistBookings", fields: [artistId], references: [id])
  
  providerId  String
  provider    User          @relation("ProviderBookings", fields: [providerId], references: [id])
  
  serviceId   String
  service     Service       @relation(fields: [serviceId], references: [id])
  
  date        DateTime
  endDate     DateTime?
  status      BookingStatus @default(PENDING)
  amount      Float
  notes       String?
  
  stripePaymentId String?
  payouts         Payout[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// ==================== MEDIA / PORTFOLIO ====================

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
}

model Media {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  type        MediaType
  url         String
  title       String?
  description String?
  metadata    Json?     // duration, plays, etc.
  
  createdAt   DateTime  @default(now())
}

// ==================== REVIEWS ====================

model Review {
  id          String   @id @default(cuid())
  
  authorId    String
  author      User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  
  targetId    String
  target      User     @relation("ReviewTarget", fields: [targetId], references: [id])
  
  bookingId   String?
  
  rating      Int      // 1-5
  comment     String?
  
  createdAt   DateTime @default(now())
}

// ==================== FORUM ====================

model ForumCategory {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  
  threads     ForumThread[]
  
  createdAt   DateTime      @default(now())
}

model ForumThread {
  id          String        @id @default(cuid())
  
  categoryId  String
  category    ForumCategory @relation(fields: [categoryId], references: [id])
  
  authorId    String
  author      User          @relation(fields: [authorId], references: [id])
  
  title       String
  content     String
  views       Int           @default(0)
  isPinned    Boolean       @default(false)
  isLocked    Boolean       @default(false)
  
  posts       ForumPost[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ForumPost {
  id          String      @id @default(cuid())
  
  threadId    String
  thread      ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User        @relation(fields: [authorId], references: [id])
  
  content     String
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// ==================== MESSAGING ====================

model Conversation {
  id          String             @id @default(cuid())
  
  participants ConversationUser[]
  messages    Message[]
  
  lastMessageAt DateTime?
  createdAt   DateTime           @default(now())
}

model ConversationUser {
  id              String       @id @default(cuid())
  
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  joinedAt        DateTime     @default(now())
  
  @@unique([conversationId, userId])
}

model Message {
  id              String       @id @default(cuid())
  
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId        String
  sender          User         @relation("SentMessages", fields: [senderId], references: [id])
  
  content         String
  readAt          DateTime?
  
  createdAt       DateTime     @default(now())
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  NEW_BOOKING
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  NEW_MESSAGE
  NEW_REVIEW
  PAYMENT_RECEIVED
}

model Notification {
  id          String           @id @default(cuid())
  
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  message     String?
  data        Json?
  readAt      DateTime?
  
  createdAt   DateTime         @default(now())
}

// ==================== SUBSCRIPTIONS ====================

enum SubscriptionPlan {
  FREE
  MID
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  EXPIRED
}

model Subscription {
  id                  String             @id @default(cuid())
  
  userId              String             @unique
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  plan                SubscriptionPlan   @default(FREE)
  status              SubscriptionStatus @default(ACTIVE)
  
  stripeCustomerId    String?
  stripeSubscriptionId String?
  stripePriceId       String?
  
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  
  commissionRate      Float              @default(0.10) // 10% default
  
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
}

// ==================== BOOSTS ====================

enum BoostType {
  STANDARD  // 24h
  PREMIUM   // 7 days
  MEGA      // 30 days
}

model Boost {
  id          String    @id @default(cuid())
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        BoostType
  startsAt    DateTime  @default(now())
  expiresAt   DateTime
  
  stripePaymentId String?
  
  createdAt   DateTime  @default(now())
}

// ==================== PAYOUTS (PROVIDER EARNINGS) ====================

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Payout {
  id              String       @id @default(cuid())
  
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  bookingId       String
  booking         Booking      @relation(fields: [bookingId], references: [id])
  
  amount          Float        // Amount before commission
  commission      Float        // Commission amount
  netAmount       Float        // Amount to pay provider
  
  status          PayoutStatus @default(PENDING)
  stripeTransferId String?
  
  scheduledAt     DateTime     // When payout should be sent
  processedAt     DateTime?    // When actually processed
  
  createdAt       DateTime     @default(now())
}

// ==================== STRIPE CONNECT ====================

model StripeAccount {
  id                String   @id @default(cuid())
  
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stripeAccountId   String   @unique
  chargesEnabled    Boolean  @default(false)
  payoutsEnabled    Boolean  @default(false)
  detailsSubmitted  Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

